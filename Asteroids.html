<!DOCTYPE html>
<html>
<head>
	<title>test</title>
</head>
<style type="text/css">
	html, body {
			width: 100%;
			height: 100%;
			margin: 0px;
			overflow: hidden;
	}
	canvas {
		width: 100%;
		height: 100%;
	}
</style>
<body>
<canvas id="canvas" onmousemove="updateMouseCoordinates(event)" onkeypress="keyPressed(event)" onclick="mouseClick()"> </canvas>
<script type="text/javascript" src="./Utils.js"></script>
<script type="text/javascript" src="./Collisions.js"></script>
<script type="text/javascript" src="./Elements.js"></script>
<script type="text/javascript">
	var canvas = document.getElementById("canvas");
	var ctx = canvas.getContext("2d");

	canvas.width = window.innerWidth;
	canvas.height = window.innerHeight;

	var mousePoint = new point(0, 0); //conterr√† la posizione del mouse
	var gameState = null;	//stato del gioco
	var keyPressed;
	var title = null;	//titolo del gioco
	var levelRect = null;	//rettangolo del livello
	var backButton = null;
	var levelNumber = 1;	//numero del livello corrente
	var currentLevel = null;	//nome del livello corrente
	var firstLevel = 1;	//numero del primo livello
	var lastLevel = 10; //numero dell'ultimo livello
	var polygons = [];
	var maxOpeningPolygons = 3;
	var maxLevelsPolygons = 2;
	var myBall = null;
	var animation = null;
	var backgroundColor = new color(10, 10, 10).makeColor(1);

	clearArea();
	//imposto primo stato di gioco
	changeGameState("opening");

	//aggiorna la dimensioni dell'area
	window.onresize = function resize() {
		canvas.width = window.innerWidth;
		canvas.height = window.innerHeight;
		//applica le modifiche
		changeGameState(gameState);
	}

	/*
	cambia lo stato del gioco
	*/
	function changeGameState(newState) {
		gameState = newState;
		//inizializza gli oggetti
		initializeObjects();
		//disegna gli oggetti
		startAnimation();
	}

	/*
	pulisce l'area di gioco
	*/
	function clearArea() {
		ctx.clearRect(0, 0, canvas.width, canvas.height);
		ctx.fillStyle = backgroundColor;
		ctx.fillRect(0, 0, canvas.width, canvas.height);
	}

	/*
	disegna l'area e gli elementi di gioco
	*/
	function drawArea() {
		canvas.width = window.innerWidth;
		canvas.height = window.innerHeight;
		//pulisco l'area
		clearArea();
		switch (gameState) {
			case "opening":
				title.setText("Start game");
				polygons[0].drawWithLights(new point(canvas.width/10, canvas.width/10));
				polygons[1].drawWithLights(new point(canvas.width/5, canvas.width/5));
				title.draw(new point(canvas.width*7/16, canvas.height/2), "Serif", false);
				bouncePolygons();
				break;

			case "levels":
				//aggiorno il nome del livello
				currentLevel = "Level "+levelNumber;
				levelName.setText(currentLevel);
				backButton.setText("Back");
				for (var i=0; i<maxLevelsPolygons; i++)
					polygons[i].drawWithLights(new point(canvas.width/10+i*10, canvas.width/10+i*20));
				levelName.draw(new point(canvas.width*15/34, canvas.height*4/5), "Serif");
				backButton.draw(new point(canvas.width/20, canvas.height/15), "Serif");
				levelRect.drawWithLights(new point(canvas.width/6, canvas.height/8));
				levelRect.drawArrowsWithLights();
				bouncePolygons();
				break;
			case "playing":
				for (var i=0; i<10; i++) {
					polygons[i].drawWithLights(new point(canvas.width/2+50*i, canvas.height/4+30*i));
				}
				myBall.drawWithLights(new point(canvas.width/2, canvas.height/2));
				bouncePolygons();
				break;
		}
	}

	/*
	inizializza gli oggetti
	*/
	function initializeObjects() {
		switch (gameState) {
			case "opening":
				title = new writingsRectangle(canvas.height/20, new color(255, 255, 255), new color(0, 255, 0), "Start game");
				polygons[0] = new polygon(Math.floor(Math.random()*3)+3, Math.random()*20+30, new color(255, 255, 255),
																	new color(50+Math.random()*205, 50+Math.random()*205, 50+Math.random()*205), 0, 1.5, 1.5, 0.5);
				polygons[1] = new polygon(Math.floor(Math.random()*3)+3, Math.random()*20+30, new color(255, 255, 255),
																	new color(50+Math.random()*205, 50+Math.random()*205, 50+Math.random()*205), 0, -1.5, -1.5, 0.5);
				break;
			case "levels":
				//aggiorno il nome del livello
				levelNumber = 1;
				currentLevel = "Level "+levelNumber;
				for (var i=0; i<maxLevelsPolygons; i++)
					polygons[i] = new polygon(Math.floor(Math.random()*3)+3, Math.random()*20+30, new color(255, 255, 255),
																		new color(50+Math.random()*205, 50+Math.random()*205, 50+Math.random()*205), 0, Math.random()*2.5, Math.random()*1.5, Math.random());
				levelName = new writingsRectangle(canvas.height/20, new color(255, 255, 255), new color(0, 255, 255), currentLevel);
				backButton = new writingsRectangle(canvas.height/20, new color(255, 255, 255), new color(0, 255, 255), "Back");
				levelRect = new roundRectangle(canvas.width*2/3, canvas.height*1/2, new color(255, 0, 255));
				break;
			case "playing":
				for (var i=0; i<10; i++) {
					polygons[i] = new polygon(6, i*5, new color(255, 255, 255), new color(200-20*i, 0+10*i, 255), 0, 0.5*i+0.5, 0.5*i+0.5, 0.05*i+0.05);
				}
				myBall = new ball(20, new color(255, 255, 255), new color(0, 255, 0));
				break;
		}
	}

	/*
	avvia le animazioni
	*/
	function startAnimation() {
		clearInterval(animation);
		switch (gameState) {
			case "opening":
				animation = setInterval(drawArea, 20);
				break;
			case "levels":
				animation = setInterval(drawArea, 20);
				break;
			case "playing":
				animation = setInterval(drawArea, 20);
 				break;
		}
	}

	/*
	salva l'ultimo tasto premuto
	*/
	function keyPressed(event) {
		keyPressed = event.keyCode();
	}

	/*
	aggiorna la posizione del muose quando si muove
	*/
	function updateMouseCoordinates(event) {
		mousePoint = new point(event.clientX, event.clientY);
	}

	/*
	Gestisce l'evento mouseClick
	*/
	function mouseClick() {
		switch(gameState) {
			case "opening":
				//con il click su "Start game" passo ai livelli
				if (mouseInRectangle(title)) {
					changeGameState("levels");
				}
			break;
			case "levels":
				//click sulla freccia di sinistra, passa al livello precedente
				if (mouseInTriangle(levelRect.leftp1, levelRect.leftp2, levelRect.leftp3)) {
					if (levelNumber > firstLevel) {
						levelNumber--;
						updateArrows();
						drawArea();
					}
				}
				//click sulla freccia di destra, passa al prossimo livello
				else if (mouseInTriangle(levelRect.rightp1, levelRect.rightp2, levelRect.rightp3)) {
					if (levelNumber < lastLevel) {
						levelNumber++;
						updateArrows();
						drawArea();
					}
				}
				//click sul bottone back
				else if (mouseInRectangle(backButton)) {
					changeGameState("opening");
				}
				else if (mouseInRectangle(levelName) || mouseInRectangle(levelRect)) {
				 	changeGameState("playing");
				}
				break;
			case "playing":
				break
		}
	}
</script>
</body>
</html>
