<!DOCTYPE html>
<html>
<head>
	<title>Progetto di Interfacce</title>
	<link rel="stylesheet" type="text/css" href="style.css">
</head>
<meta charset="utf-8"/>
<body>
	<div class="container" style="background-color: #333333">

		<canvas id="canvas" width="900" height="600" onmousemove="mouseMove(event)" onkeydown="keyPressed(event)" onclick="mouseClick()" onmousedown="mouseDown()" onmouseup="mouseUp()">
		</canvas>
		<button class="startButton" id="startButton">
			<div class="startText" id="startText">Start</div>
		</button>
		<button class="backButton" id="backButton">
			<div class="backText" id="backText">Back</div>
		</button>
		<button class="tryButton" id="tryButton">
			<div class="tryText" id="tryText">Try</div>
		</button>
		<script type="text/javascript" src="./Utils.js"></script>
		<script type="text/javascript" src="./Collisions.js"></script>
		<script type="text/javascript" src="./Elements.js"></script>
		<script type="text/javascript">
			var canvas = document.getElementById("canvas");
			var ctx = canvas.getContext("2d");
			document.onkeydown = keyPressed;

			var startButton = document.querySelector(".startButton");
			var backButton = document.querySelector(".backButton");
			var tryButton = document.querySelector(".tryButton");
			hideButtons("editor");


			function hideButtons(gameState) {
				if (gameState == "opening")
					startButton.style.display='none';
				if (gameState =="editor") {
					backButton.style.display='none';
					tryButton.style.display='none';
				}
			}

			function showButtons(gameState) {
				if (gameState == "opening")
					startButton.style.display='block';
				if (gameState =="editor") {
					backButton.style.display='block';
					tryButton.style.display='block';
				}
			}

			function setStartListener() {
				startButton.addEventListener("click", function clickS(e) {
					startButton.removeEventListener("click", clickS);
					hideButtons("opening");
					showButtons("editor");
					changeGameState("editor");
				});
			};

			function setEditorListeners() {
				backButton.addEventListener("click", function clickB(e) {
					backButton.removeEventListener("click", clickB);
					hideButtons("editor");
					showButtons("opening");
					changeGameState("opening");
				});
				tryButton.addEventListener("click", function clickT(e) {
					tryButton.removeEventListener("click", clickT);
					hideButtons("editor");
					changeGameState("playing");
				});
			};

			var mousePoint = new point(0, 0); //conterr√† la posizione del mouse
			var gameState = null;	//stato del gioco
			var keyPressed;
			var choosePolygon = null;
			var rectangleEditor = null;
			var polygons = [];
			var maxOpeningPolygons = 3;
			var maxLevelsPolygons = 2;
			var myBall = null;
			var animation = null;
			var backgroundColor = new color(30, 30, 30).makeColor(1);
			var backgroundColor2 = new color(10, 10, 10).makeColor(1);
			var gravity = 0;
			var bounce = -0.6;
			var ballClicked = false;
			var shotPoint = null;
			var dragging = false;
			var draggingIndex = -1;
			var placedPolygons = [];
			var placedCenters = [];
			var draggedPolygon = null;
			var npp = 0;

			clearArea();
			//imposto primo stato di gioco
			changeGameState("opening");

			window.addEventListener('wheel', function(event) {
				for (var i=0; i<placedPolygons.length; i++) {
					if (placedPolygons[i] && contains(placedPolygons[i], mousePoint)) {
						if (event.deltaY < 0 && placedPolygons[i].size >= 20) {
							placedPolygons[i].size -= 5;
							console.log("SCROLL SMALL");
						}
						if (event.deltaY > 0) {
							placedPolygons[i].size += 5;
							console.log("SCROLL BIG");
						}
					}
				}
			});

			/*
			cambia lo stato del gioco
			*/
			function changeGameState(newState) {
				if (gameState == null || newState != gameState) {
					gameState = newState;
					//inizializza gli oggetti
					initializeObjects();
					if (gameState == "opening") {
						setStartListener();
					}
					if (gameState == "editor") {
						setEditorListeners();
					}
				}
				//disegna gli oggetti
				startAnimation();
				}

			/*
			pulisce l'area di gioco
			*/
			function clearArea() {
				ctx.clearRect(0, 0, canvas.width, canvas.height);
				ctx.fillStyle = backgroundColor2;
				ctx.fillRect(0, 0, canvas.width, canvas.height);
			}

			/*
			disegna l'area e gli elementi di gioco
			*/
			function drawArea() {
				//pulisco l'area
				clearArea();
				switch (gameState) {
					case "opening":
						polygons[0].drawWithLights(new point(canvas.width/10, canvas.width/10));
						polygons[1].drawWithLights(new point(canvas.width/5, canvas.width/5));
						bouncePolygons();
						break;

					case "editor":
						for (var i=0; i<4; i++) {
							polygons[i].drawWithLights(new point(canvas.width/12, canvas.height*(3+i)/9));
						}
						polygons[4].drawWithLights(new point(canvas.width*11/12, canvas.height*4/9));
						if (dragging)
							draggedPolygon.drawWithLights(mousePoint);
						for (var i=0; i<placedPolygons.length; i++) {
							if (i != draggingIndex && placedPolygons[i] != null)
								placedPolygons[i].drawWithLights(placedCenters[i]);
						}
						rectangleEditor.drawWithLights(new point(canvas.width/6, canvas.height/6));
						break;
					case "playing":
						myBall.drawWithLights();
						polygons[0].drawWithLights(new point(canvas.width*8/9, canvas.height/2));
						polygons[1].drawWithLights(new point(canvas.width*2/9, canvas.height/3));

						for (var i=0; i<polygons.length; i++) {
							console.log(detectCircleShapeCollision(myBall, polygons[i]));
							if (detectCircleShapeCollision(myBall, polygons[i])) {
								myBall.vx = -myBall.vx;
								myBall.vy = -myBall.vy;
								//applyBonus(myBall, polygons[i]);
							}
						}
						break;
				}
			}

			/*
			inizializza gli oggetti
			*/
			function initializeObjects() {
				switch (gameState) {
					case "opening":
						clearPolygons();
						polygons[0] = new polygon(Math.floor(Math.random()*3)+3, Math.random()*20+30, new color(255, 255, 255),
																			new color(50+Math.random()*205, 50+Math.random()*205, 50+Math.random()*205), 0, 1.5, 1.5, 0.5, 1, false);
						polygons[1] = new polygon(Math.floor(Math.random()*3)+3, Math.random()*20+30, new color(255, 255, 255),
																			new color(50+Math.random()*205, 50+Math.random()*205, 50+Math.random()*205), 0, -1.5, -1.5, 0.5, 1, false);
						break;
					case "editor":
					clearPolygons();
						rectangleEditor = new roundRectangle(canvas.width*2/3, canvas.height*2/3, new color(255, 0, 0));
						for (var i=0; i<4; i++) {
							polygons[i] = new polygon(3+i, 30, new color(255, 255, 255), new color(255, 0, 255), Math.PI*3/2, 0, 0, 0, 0, false);
						}
						polygons[4] = new polygon(20, 20, new color(255, 255, 255), new color(0, 255, 0), 0, 0, 0, 0, 0, false);
						break;
					case "playing":
						clearPolygons();
						polygons[0] = new polygon(6, 60, new color(255, 255, 255), new color(200-20, 0+10, 255), 0, 0, 0, 0, 1.5, true);
						polygons[1] = new polygon(6, 50, new color(255, 255, 255), new color(255, 0, 0), 0, 0, 0, 0, 1.5, true);
						myBall = new ball(new point(canvas.width/2, canvas.height*9/10), 25, new color(255, 255, 255), new color(0, 255, 0), 0, 0);
						break;
				}
			}

			/*
			avvia le animazioni
			*/
			function startAnimation() {
				clearInterval(animation);
				switch (gameState) {
					case "opening":
						animation = setInterval(drawArea, 10);
						break;
					case "editor":
						animation = setInterval(drawArea, 20);
						break;
					case "playing":
						animation = setInterval(drawArea, 20);
		 				break;
				}
			}

			/*
			salva l'ultimo tasto premuto
			*/
			function keyPressed(event) {
				key = event.keyCode;
				if (gameState == "opening") {
					if (key == 13)
						changeGameState("editor");
				}
			}

			/*
			aggiorna la posizione del muose quando si muove
			*/
			function updateMouseCoordinates(event) {
				console.log(event.clientX, event.clientY);
				mousePoint = findRelativeCoordinates(event.clientX, event.clientY);
			}

			/*
			Gestisce l'evento mouseClick
			*/
			function mouseClick() {
				switch(gameState) {
					case "opening":
					break;

					case "editor":
					break;
				}
			}

			function mouseDown() {
				if (gameState == "playing") {
					if (mouseInCircle(myBall.center, myBall.radius)) {
						ballClicked = true;
					}
					myBall.line = true;
				}
				if (gameState == "editor") {
					for (var i=0; i<5; i++) {
						if (contains(polygons[i], mousePoint)) {
							dragging = true;
							draggingIndex = -1;
							draggedPolygon = clonePolygon(polygons[i]);
							break;
						}
					}
					for (var i=0; i<placedPolygons.length; i++) {
						if (placedPolygons[i] && contains(placedPolygons[i], mousePoint)) {
							dragging = true;
							draggingIndex = i;
							draggedPolygon = clonePolygon(placedPolygons[i]);
						}
					}
				}
			}

			function mouseUp() {
				if (gameState == "playing") {
					if (ballClicked == true) {
						shotPoint = mousePoint;
						var vx = shotPoint.x - myBall.center.x;
						var vy = shotPoint.y - myBall.center.y;
						myBall.setSpeed(-vx/2, -vy/2);
						ballClicked = false;
						gravity = 1;
					}
					myBall.line = false;
				}
				if (gameState == "editor") {
					if (dragging) {
						if (mouseInRectangle(rectangleEditor)) {
							if (draggingIndex == -1) {
								placedPolygons[npp] = clonePolygon(draggedPolygon);
								placedCenters[npp] = mousePoint;
								npp = findFreeSpot();
							}
							else {
								placedCenters[draggingIndex] = mousePoint;
								draggingIndex = -1;
							}
						}
						else {
							placedPolygons[draggingIndex] = null;
							placedCenters[draggingIndex] = null;
							npp = draggingIndex;
						}
						draggedPolygon = null;
						dragging = false;
					}
				}
			}

			function mouseMove(event) {
				updateMouseCoordinates(event);
			}

			function clearPolygons() {
				polygons = null;
				polygons = [];
			}

			function findFreeSpot() {
				place = -1;
				for (var i=0; i<placedPolygons.length; i++) {
					if (placedPolygons == null)
						place = i;
				}
				if (place == -1) {
					place = placedPolygons.length + 1;
				}
				return place;
			}
		</script>
	</div>
</body>
</html>
